---
title: "TB Patient Flows Modelling"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(lubridate)
library(brms)
library(tidybayes)

source("https://raw.githubusercontent.com/nbanho/helper/refs/heads/main/R/plotting.R")
source("https://raw.githubusercontent.com/nbanho/helper/refs/heads/main/R/formatting.R")
```

## Check convergence of simulation results

```{r check convergence}
# files for one day
sim_files <- list.files(
  "modelling-results/uncertain/2024-06-26/",
  pattern = ".csv$", full.names = TRUE
)

# compute expected infections per simulation
sim_daily_inf <- map_dfr(sim_files, function(file) {
  read_csv(file) %>%
    mutate(
      sim = as.integer(str_extract(basename(file), "(?<=_sim_)\\d+")),
      risk = 1 - exp(-conc_diffusion)
    ) %>%
    group_by(sim) %>%
    summarise(exp_inf = sum(risk) / sum(duration) * 3600) %>%
    ungroup()
})

# plot convergence
sim_daily_inf %>%
  ggplot(aes(x = sim, y = exp_inf)) +
  geom_point() +
  geom_segment(aes(yend = 0, xend = sim))
cumquantile <- function(x, p = .5) {
  purrr::map_dbl(seq_along(x), ~ quantile(x[1:.x], p))
}
sim_daily_inf %>%
  arrange(sim) %>%
  mutate(
    median = cumquantile(exp_inf, .5),
    lower = cumquantile(exp_inf, .025),
    upper = cumquantile(exp_inf, .975),
    lower_80 = cumquantile(exp_inf, .1),
    upper_80 = cumquantile(exp_inf, .9)
  ) %>%
  ggplot(aes(x = sim)) +
  geom_line(aes(y = median)) +
  geom_line(aes(y = lower), linetype = "dashed", color = "blue") +
  geom_line(aes(y = upper), linetype = "dashed", color = "blue") +
  geom_line(aes(y = lower_80), linetype = "dashed", color = "skyblue") +
  geom_line(aes(y = upper_80), linetype = "dashed", color = "skyblue")
```

## Risk of infection over time

```{r risk over time}
# modelling results
data_dir <- "modelling-results/uncertain/"
folders <- list.dirs(data_dir, recursive = FALSE, full.names = TRUE)
files <- list.files(folders, pattern = "\\.csv$", full.names = TRUE)
daily_risk_df <- map_dfr(files, function(f) {
  sim <- str_extract(basename(f), "(?<=_sim_)\\d+")
  date <- basename(dirname(f))
  df <- read_csv(f) %>%
    filter(hour_idx < 12) %>%
    mutate(
      risk_diffusion = 1 - exp(-conc_diffusion),
      risk_mixed = 1 - exp(-conc_mixed)
    ) %>%
    summarise(
      infections_diffusion = sum(risk_diffusion),
      infections_mixed = sum(risk_mixed),
      duration = sum(duration)
    ) %>%
    mutate(sim = sim, date = date) %>%
    dplyr::select(date, sim, everything())
  return(df)
})

# compute infection rates
daily_risk_df <- daily_risk_df %>%
  mutate(
    date = as.Date(date),
    rate_diffusion = infections_diffusion / duration * 3600 * 12,
    rate_mixed = infections_mixed / duration * 3600 * 12
  )

# plot risk over time
risk_time_pl <- daily_risk_df %>%
  ggplot(aes(x = date, y = rate_diffusion)) +
  stat_lineribbon(
    .width = c(0.5, 0.8, 0.95),
  ) +
  scale_fill_brewer(
    palette = "Blues",
    labels = rev(c("50%", "80%", "95%"))
  ) +
  stat_summary(
    fun = median, geom = "point", shape = 23, size = 2,
    colour = "black", fill = "white"
  ) +
  labs(
    fill = "Credible interval",
    x = "Date",
    y = "Estimated daily number of TB infections"
  ) +
  theme_custom() +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c(.95, .95),
    legend.background = element_rect(
      fill = "white", color = "black", linewidth = 1 / cm(1)
    )
  )
risk_time_pl
```


## Intervention effects

```{r load data}
# summarise rate across simulations
rate_df <- daily_risk_df %>%
  group_by(date) %>%
  summarise(
    across(c(rate_diffusion, rate_mixed), median)
  ) %>%
  ungroup() %>%
  mutate(
    rate_ratio = rate_diffusion / rate_mixed
  )

# add interventions
interventions <- read_csv("data-clean/mapping_dates_interventions.csv") %>%
  mutate(
    date = as.Date(date),
    study_phase = factor(
      study_phase,
      levels = c("Baseline", "First intervention", "Second intervention")
    )
  )

rate_df <- rate_df %>%
  left_join(interventions, by = "date")

# add weekday
rate_df <- rate_df %>%
  mutate(
    weekday = weekdays(date, abbreviate = TRUE),
    weekday = factor(
      weekday,
      levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
    )
  )

# add study day
rate_df <- rate_df %>%
  mutate(study_day = as.numeric(date - min(date)))

# add air exchange rate
aer_data <- read_csv("data-clean/environmental/air-exchange-rate.csv") %>%
  mutate(date = as.Date(date)) %>%
  filter(device == "Aranet4 272D2") %>%
  dplyr::select(date, aer_tmb) %>%
  rename(aer = aer_tmb)
rate_df <- rate_df %>%
  left_join(aer_data, by = "date")

# inspect risk ratio
rate_df %>%
  ggplot(aes(x = date, y = rate_ratio, color = study_phase)) +
  geom_point()
hist(log(mr_ratio$risk_ratio))

# regression model
logmodel_rr <- brm(
  log(rate_df) ~ study_day + study_phase + weekday + I(1 / aer),
  data = rate_df,
  family = gaussian(),
  chains = 4, cores = 4, iter = 2000,
  seed = 12345
)
summary(logmodel_rr)

# parameter samples
effects_smpls <- spread_draws(
  logmodel_rr,
  b_study_phaseFirstintervention,
  b_study_phaseSecondintervention
) %>%
  mutate(
    b_study_phaseBaseline = 0
  ) %>%
  pivot_longer(
    starts_with("b_"),
    names_to = "parameter",
    values_to = "value"
  ) %>%
  mutate(
    study_phase = case_when(
      parameter == "b_study_phaseBaseline" ~ "Baseline",
      parameter == "b_study_phaseFirstintervention" ~ "First intervention",
      parameter == "b_study_phaseSecondintervention" ~ "Second intervention"
    ),
    study_phase = factor(
      study_phase,
      levels = c("Baseline", "First intervention", "Second intervention")
    ),
    rr = exp(value),
    change = rr - 1
  )

# plot effects
effects_pl <- effects_smpls %>%
  ggplot(aes(x = study_phase, y = change)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  stat_interval(.width = c(0.5, 0.8, 0.95)) +
  stat_summary(
    fun = mean, geom = "point", shape = 23, size = 2,
    colour = "black", fill = "white"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(0.1),
    labels = function(x) x * 100
  ) +
  scale_color_brewer(
    labels = rev(c("50%", "80%", "95%"))
  ) +
  scale_x_discrete(
    labels = c(
      "Baseline",
      "1<sup>st</sup> intervention",
      "2<sup>nd</sup> intervention"
    )
  ) +
  labs(
    colour = "Credible interval",
    x = "Study phase",
    y = "Change in infection rsik (%)"
  ) +
  theme_custom() +
  theme(
    legend.position = c(0, 0),
    legend.justification = c(0, 0),
    axis.title.x = element_blank(),
    axis.text.x = element_markdown(),
    legend.background = element_rect(fill = "white", color = "black")
  ) +
  guides(colour = guide_legend(reverse = TRUE))
effects_pl

save_plot(
  effects_pl, "results/modelling-intervention-effects.png",
  w = 8, h = 8
)
```


## Risk contribution of close proximity 

```{r}

```

```{r load risk data and add covariates}
# modelling results for variable aer
data_dir_var <- "modelling-results/variable_aer/"
folders_var <- list.dirs(data_dir_var, recursive = FALSE, full.names = TRUE)
mr_variable_aer <- map_dfr(folders_var, function(folder) {
  date_val <- basename(folder)
  csv_file <- list.files(folder, pattern = "\\.csv$", full.names = TRUE)
  df <- read_csv(csv_file)
  df$date <- as.Date(date_val)
  df
}) %>%
  filter(hour_idx < 12)

# add interventions
interventions <- read_csv("data-clean/mapping_dates_interventions.csv") %>%
  mutate(
    date = as.Date(date),
    study_phase = factor(
      study_phase,
      levels = c("Baseline", "First intervention", "Second intervention")
    )
  )
mr_variable_aer <- mr_variable_aer %>%
  left_join(interventions, by = "date")

# add weekday
mr_variable_aer <- mr_variable_aer %>%
  mutate(
    weekday = weekdays(date, abbreviate = TRUE),
    weekday = factor(
      weekday,
      levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
    )
  )

# add study day
mr_variable_aer <- mr_variable_aer %>%
  mutate(study_day = as.numeric(date - min(date)))

# add air exchange rate
aer_data <- read_csv("data-clean/environmental/air-exchange-rate.csv") %>%
  mutate(date = as.Date(date)) %>%
  filter(device == "Aranet4 272D2") %>%
  dplyr::select(date, aer_tmb) %>%
  rename(aer = aer_tmb)
mr_variable_aer <- mr_variable_aer %>%
  left_join(aer_data, by = "date")

# add tracking features
files_track <- list.files("data-clean/tracking/features/", full.names = TRUE)
track_featr <- map_dfr(files_track, read_csv) %>%
  group_by(date) %>%
  mutate(sum_hcw = sum(healthcare_worker, na.rm = TRUE)) %>%
  mutate(healthcare_worker = if_else(
    sum_hcw == 0, NA, healthcare_worker
  )) %>%
  ungroup() %>%
  dplyr::select(-sum_hcw) %>%
  rename(
    proximity_time = close_proximity_time_1.0m,
    proximity_contacts = close_proximity_contacts_1.0m_60s
  )
mr_variable_aer <- mr_variable_aer %>%
  left_join(track_featr, by = c("new_track_id", "date", "hour_idx"))

# compute risk
mr_variable_aer <- mr_variable_aer %>%
  mutate(
    risk = 1 - exp(-conc_diffusion),
    hour = hour_idx,
    inv_aer = 1 / aer
  )
```

### Association with daytime and weekday

```{r association time}
hurdle_contact <- brm(
  bf(
    risk ~ offset(duration) + study_day + inv_aer + sqrt(proximity_contacts),
    hu ~ offset(duration) + study_day + weekday + hour + I(hour^2)
  ),
  data = mr_variable_aer,
  family = hurdle_lognormal(),
  chains = 4, cores = 4, iter = 1000,
  seed = 12345
)

summary(hurdle_contact)

# aggregate risks by daytime
mr_time <- mr_variable_aer %>%
  rename(hour = hour_idx) %>%
  mutate(risk = 1 - exp(-conc_diffusion)) %>%
  group_by(date, weekday, study_phase, study_day, aer, hour) %>%
  summarise(
    inf = sum(risk),
    duration = sum(duration)
  ) %>%
  ungroup() %>%
  mutate(
    inf_rate = inf / duration * 3600,
    inv_aer = 1 / aer
  )

mr_weekday <- mr_variable_aer %>%
  mutate(risk = 1 - exp(-conc_diffusion)) %>%
  group_by(date, weekday, study_phase, study_day, aer) %>%
  summarise(
    inf = sum(risk),
    duration = sum(duration)
  ) %>%
  ungroup() %>%
  mutate(
    inf_rate = inf / duration * 3600,
    inv_aer = 1 / aer
  )

summary(lm(log(inf_rate) ~ study_phase + study_day + weekday + inv_aer, data = mr_weekday))
summary(lm(inv_aer ~ weekday, data = mr_weekday))

# inspect data
sum(mr_time$inf_rate == 0) / nrow(mr_time)
mr_time %>%
  ggplot(aes(x = factor(hour), y = inf_rate)) +
  facet_wrap(~weekday, ncol = 3) +
  geom_boxplot()
hist(sqrt(mr_time$inf_rate))

mr_time %>%
  group_by(weekday, hour) %>%
  summarise(
    q025 = quantile(inf_rate, 0.025),
    q25 = quantile(inf_rate, 0.25),
    q50 = quantile(inf_rate, 0.5),
    q75 = quantile(inf_rate, 0.75),
    q975 = quantile(inf_rate, 0.975)
  ) %>%
  View()

# regression model
hurdle_time <- brm(
  bf(
    inf_rate ~ study_day + study_phase + weekday + hour + I(hour^2) + inv_aer,
    hu ~ study_day + study_phase + weekday + hour + I(hour^2) + inv_aer
  ),
  data = mr_time,
  family = hurdle_lognormal(),
  chains = 4, cores = 4, iter = 1000,
  seed = 12345
)
summary(hurdle_time)

# time grid
time_grid <- expand.grid(
  hour = seq(0, 11, by = 1),
  weekday = levels(mr_time$weekday),
  study_phase = "Baseline",
  study_day = 0,
  inv_aer = 1 / median(mr_time$aer)
)

# predictions
time_pred <- posterior_predict(hurdle_time, newdata = time_grid) %>%
  t() %>%
  as.data.frame() %>%
  bind_cols(time_grid) %>%
  pivot_longer(
    -all_of(names(time_grid)),
    names_to = "draw",
    values_to = "risk"
  ) %>%
  mutate(draw = as.integer(str_remove(draw, "V")))

# plot
time_pl <- time_pred %>%
  ggplot(aes(x = hour, y = risk, colour = weekday)) +
  tidybayes::stat_interval(
    aes(group = hour, alpha = after_stat(factor(.width))),
    .width = c(0.5, 0.8, 0.95), colour = "gray50"
  ) +
  stat_summary(
    aes(group = weekday, color = weekday),
    fun = mean, geom = "line",
  ) +
  stat_summary(
    aes(group = weekday, fill = weekday),
    fun = mean, geom = "point", shape = 23, size = 2, colour = "black"
  ) +
  scale_y_continuous(
    labels = function(x) x,
    limits = c(0, NA),
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  scale_x_continuous(
    breaks = 0:12,
    labels = function(x) x + 6,
    expand = expansion(add = c(0.05, 0.05))
  ) +
  scale_color_paletteer_d(
    "colRoz::uluru",
    breaks = levels(mr_time$weekday),
    name = "Weekday"
  ) +
  scale_fill_paletteer_d(
    "colRoz::uluru",
    breaks = levels(mr_time$weekday),
    name = "Weekday"
  ) +
  scale_alpha_manual(
    values = c("0.5" = 0.7, "0.8" = 0.4, "0.95" = 0.1),
    labels = c("50%", "80%", "95%"),
    name = "Prediction interval"
  ) +
  labs(
    x = "Daytime (hour)",
    y = "Predicted infections per 100,000 attendees"
  ) +
  theme_custom() +
  theme(
    legend.position = c(1, 1),
    legend.justification = c(1, 1)
  )
time_pl
``` 


### Association with the air exchange rate

```{r association aer}
# aer grid
aer_grid <- expand.grid(
  aer = seq(5, 30, by = 2.5),
  weekday = levels(mr_time$weekday)[6],
  hour = 6,
  study_phase = "Baseline",
  study_day = 0,
  ptp_z = 0,
  pcr_z = 0
) %>%
  mutate(inv_aer = 1 / aer)

# predictions
aer_pred <- posterior_predict(hurdle_time, newdata = aer_grid) %>%
  t() %>%
  as.data.frame() %>%
  bind_cols(aer_grid) %>%
  pivot_longer(
    -all_of(names(aer_grid)),
    names_to = "draw",
    values_to = "risk"
  ) %>%
  mutate(draw = as.integer(str_remove(draw, "V")))

# plot
aer_pl <- aer_pred %>%
  ggplot(aes(x = aer, y = risk)) +
  stat_interval(
    aes(group = aer, alpha = after_stat(factor(.width))),
    .width = c(0.5, 0.8, 0.95), colour = "gray50"
  ) +
  stat_summary(
    fun = mean, geom = "line", color = "skyblue"
  ) +
  stat_summary(
    aes(group = aer),
    fun = mean, geom = "point", shape = 23, size = 2,
    colour = "black", fill = "skyblue"
  ) +
  scale_y_continuous(
    labels = function(x) x * 1e5,
    limits = c(0, NA),
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  scale_x_continuous(
    limits = c(5, 30),
    breaks = seq(5, 30, by = 5),
    expand = expansion(add = c(0.5, 0.5))
  ) +
  scale_alpha_manual(
    values = c("0.5" = 0.7, "0.8" = 0.4, "0.95" = 0.1),
    labels = c("50%", "80%", "95%"),
    name = "Prediction interval"
  ) +
  labs(
    x = "Air exchange rate (h<sup>-1</sup>)",
    y = "Predicted infections per 100,000 attendees"
  ) +
  theme_custom() +
  theme(
    legend.position = c(1, 1),
    legend.justification = c(1, 1),
    axis.title.x = element_markdown()
  )
aer_pl
```


### Association with contact patterns

```{r association contact}
contact_grid <- expand.grid(
  proximity_contacts_rate = seq(10, 60, by = 10),
  proximity_time_prop = c(0.4, 0.75, 1),
  weekday = levels(mr_time$weekday)[6],
  hour = 6,
  study_phase = "Baseline",
  study_day = 0,
  inv_aer = 1 / median(mr_time$aer)
) %>%
  mutate(
    pcr_z = (proximity_contacts_rate - mean(mr_time$proximity_contacts_rate, na.rm = TRUE)) /
      sd(mr_time$proximity_contacts_rate, na.rm = TRUE),
    ptp_z = (proximity_time_prop - mean(mr_time$proximity_time_prop, na.rm = TRUE)) /
      sd(mr_time$proximity_time_prop, na.rm = TRUE)
  )

# predictions
contact_pred <- posterior_predict(hurdle_time, newdata = contact_grid) %>%
  t() %>%
  as.data.frame() %>%
  bind_cols(contact_grid) %>%
  pivot_longer(
    -all_of(names(contact_grid)),
    names_to = "draw",
    values_to = "risk"
  ) %>%
  mutate(draw = as.integer(str_remove(draw, "V"))) %>%
  mutate(
    proximity_time_prop = factor(
      proximity_time_prop * 100,
      levels = sort(unique(proximity_time_prop * 100)),
    )
  )

# plot
contact_pl <- contact_pred %>%
  ggplot(aes(x = proximity_contacts_rate, y = risk, colour = proximity_time_prop)) +
  stat_interval(
    aes(group = proximity_contacts_rate, alpha = after_stat(factor(.width))),
    .width = c(0.5, 0.8, 0.95), colour = "gray50"
  ) +
  stat_summary(
    aes(group = proximity_time_prop, color = proximity_time_prop),
    fun = mean, geom = "line"
  ) +
  stat_summary(
    aes(group = proximity_time_prop, fill = proximity_time_prop),
    fun = mean, geom = "point", shape = 23, size = 2,
    colour = "black"
  ) +
  scale_y_continuous(
    labels = function(x) x * 1e5,
    limits = c(0, NA),
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  scale_color_paletteer_d(
    "NineteenEightyR::miami1",
    name = "Time in close proximity (%)",
    breaks = levels(contact_pred$proximity_time_prop)
  ) +
  scale_fill_paletteer_d(
    "NineteenEightyR::miami1",
    name = "Time in close proximity (%)",
    breaks = levels(contact_pred$proximity_time_prop)
  ) +
  scale_alpha_manual(
    values = c("0.5" = 0.7, "0.8" = 0.4, "0.95" = 0.1),
    labels = c("50%", "80%", "95%"),
    name = "Prediction interval"
  ) +
  labs(
    x = "Air exchange rate (h<sup>-1</sup>)",
    y = "Predicted infections per 100,000 attendees"
  ) +
  theme_custom() +
  theme(
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    axis.title.x = element_markdown()
  )
contact_pl
```
